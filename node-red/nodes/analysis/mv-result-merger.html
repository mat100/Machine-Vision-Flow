<script type="text/javascript">
    RED.nodes.registerType('mv-result-merger', {
        category: 'machine vision',
        color: '#f09090',
        defaults: {
            name: {value: ""},
            inputCount: {value: 2, validate: function(v) { return v >= 2 && v <= 10; }},
            timeout: {value: 1000},
            ruleType: {value: "all_pass"},
            minRequired: {value: 1},
            customRule: {value: "// Custom JavaScript rule\n// Return true for PASS, false for FAIL\n// Available: detections array, messages array\n\nreturn detections.every(d => d.found);"},
            saveToHistory: {value: true},
            apiUrl: {value: "http://localhost:8000"}
        },
        inputs: 1,
        outputs: 1,
        icon: "join.png",
        label: function() {
            return this.name || `Merger (${this.inputCount})`;
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        paletteLabel: "result merger",
        inputLabels: function(index) {
            return "detection " + (index + 1);
        },
        outputLabels: ["merged result"],
        oneditprepare: function() {
            const node = this;

            // Initialize CodeMirror for custom rule
            if (window.CodeMirror) {
                node.customRuleEditor = CodeMirror.fromTextArea(
                    document.getElementById("node-input-customRule"),
                    {
                        mode: "javascript",
                        lineNumbers: true,
                        theme: "default",
                        height: "150px"
                    }
                );
            }

            // Toggle custom rule editor
            $("#node-input-ruleType").on('change', function() {
                if ($(this).val() === 'custom') {
                    $("#custom-rule-container").show();
                } else {
                    $("#custom-rule-container").hide();
                }

                if ($(this).val() === 'min_count') {
                    $("#min-count-container").show();
                } else {
                    $("#min-count-container").hide();
                }
            }).trigger('change');

            // Update input count label
            $("#node-input-inputCount").on('change input', function() {
                $("#input-count-value").text($(this).val());
            });
        },
        oneditsave: function() {
            // Save custom rule from CodeMirror
            if (this.customRuleEditor) {
                this.customRule = this.customRuleEditor.getValue();
            }
        },
        oneditcancel: function() {
            // Clean up CodeMirror
            if (this.customRuleEditor) {
                this.customRuleEditor = null;
            }
        }
    });
</script>

<script type="text/html" data-template-name="mv-result-merger">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>

    <div class="form-row">
        <label for="node-input-apiUrl"><i class="fa fa-server"></i> API URL</label>
        <input type="text" id="node-input-apiUrl" placeholder="http://localhost:8000">
    </div>

    <hr>
    <h4>Input Configuration</h4>

    <div class="form-row">
        <label for="node-input-inputCount"><i class="fa fa-list-ol"></i> Input Count</label>
        <input type="range" id="node-input-inputCount" min="2" max="10" style="width: 200px;">
        <span id="input-count-value" style="margin-left: 10px; font-weight: bold;">2</span>
        <div class="form-tips">
            Number of detection inputs to wait for before merging
        </div>
    </div>

    <div class="form-row">
        <label for="node-input-timeout"><i class="fa fa-clock-o"></i> Timeout (ms)</label>
        <input type="number" id="node-input-timeout" min="100" max="10000" step="100" style="width: 100px;">
        <span style="margin-left: 10px; color: #666;">Max wait time for all inputs</span>
    </div>

    <hr>
    <h4>Decision Logic</h4>

    <div class="form-row">
        <label for="node-input-ruleType"><i class="fa fa-gavel"></i> Rule Type</label>
        <select id="node-input-ruleType" style="width: 250px;">
            <option value="all_pass">All must pass</option>
            <option value="any_pass">Any must pass</option>
            <option value="min_count">Minimum count</option>
            <option value="custom">Custom JavaScript</option>
        </select>
    </div>

    <div id="min-count-container" style="display: none;">
        <div class="form-row">
            <label for="node-input-minRequired"><i class="fa fa-check"></i> Min Required</label>
            <input type="number" id="node-input-minRequired" min="1" max="10" style="width: 100px;">
            <span style="margin-left: 10px; color: #666;">Minimum passing detections</span>
        </div>
    </div>

    <div id="custom-rule-container" style="display: none;">
        <div class="form-row">
            <label for="node-input-customRule"><i class="fa fa-code"></i> Custom Rule</label>
            <div style="margin-left: 100px;">
                <textarea id="node-input-customRule" style="width: 100%; height: 150px; font-family: monospace;"></textarea>
            </div>
        </div>
        <div class="form-tips" style="margin-left: 100px;">
            <b>Available variables:</b>
            <ul>
                <li><code>detections</code> - Array of detection results</li>
                <li><code>messages</code> - Array of input messages</li>
            </ul>
            <b>Example:</b>
            <pre style="background: #f4f4f4; padding: 5px;">
// Critical parts must be found
const critical = ["Part_A", "Part_B"];
const criticalFound = detections
  .filter(d => critical.includes(d.name))
  .every(d => d.found);
return criticalFound;</pre>
        </div>
    </div>

    <hr>
    <h4>History</h4>

    <div class="form-row">
        <label for="node-input-saveToHistory"><i class="fa fa-history"></i> Save to History</label>
        <input type="checkbox" id="node-input-saveToHistory" style="width: auto;">
        <label for="node-input-saveToHistory" style="width: auto; margin-left: 10px;">
            Save inspection results to history buffer
        </label>
    </div>
</script>

<script type="text/html" data-help-name="mv-result-merger">
    <p>Merges results from multiple detection nodes and applies decision logic.</p>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>image_id <span class="property-type">string</span></dt>
        <dd>Used to correlate inputs from the same image</dd>
        <dt>detections <span class="property-type">array</span></dt>
        <dd>Array of detection results from previous nodes</dd>
    </dl>

    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload.result <span class="property-type">string</span></dt>
        <dd>Overall result: PASS, FAIL, or ERROR</dd>
        <dt>payload.all_detections <span class="property-type">array</span></dt>
        <dd>Combined array of all detection results</dd>
        <dt>payload.summary <span class="property-type">object</span></dt>
        <dd>Statistics about the detections</dd>
        <dt>payload.failed_checks <span class="property-type">array</span></dt>
        <dd>List of failed detection names</dd>
    </dl>

    <h3>Details</h3>
    <p>This node waits for multiple detection inputs and combines them into a single result.</p>

    <h4>How it works:</h4>
    <ol>
        <li>Waits for the configured number of inputs (or timeout)</li>
        <li>Correlates inputs using the image_id</li>
        <li>Applies the selected decision rule</li>
        <li>Outputs the combined result</li>
    </ol>

    <h4>Decision Rules:</h4>
    <ul>
        <li><b>All must pass</b> - Every detection must be successful</li>
        <li><b>Any must pass</b> - At least one detection must succeed</li>
        <li><b>Minimum count</b> - At least N detections must pass</li>
        <li><b>Custom JavaScript</b> - Write custom logic for complex rules</li>
    </ul>

    <p><b>Note:</b> All inputs must have the same image_id for proper correlation.</p>
</script>