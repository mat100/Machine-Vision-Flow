<!-- FINAL COMPLETE WORKING VERSION -->

<div style="background: #1e1e1e; border-radius: 8px; width: 100%; margin: 0; padding: 0; box-sizing: border-box;">

    <!-- Header -->
    <div style="background: #2196F3; color: white; padding: 10px 15px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 16px; font-weight: 500;">
                <i class="fa fa-video-camera"></i> Live Preview
            </span>
            <span style="font-size: 14px;">
                <span ng-if="msg.payload.streaming" style="color: #4CAF50;">● STREAMING</span>
                <span ng-if="!msg.payload.streaming" style="color: #f44336;">● STOPPED</span>
            </span>
        </div>
    </div>

    <!-- Image Display -->
    <div style="position: relative; width: 100%; height: 380px; background: black; display: flex; align-items: center; justify-content: center; overflow: hidden;">

        <!-- No stream message -->
        <div ng-if="!msg.stream_url" style="text-align: center; color: #888;">
            <i class="fa fa-video-camera fa-3x" style="opacity: 0.3;"></i>
            <p style="margin-top: 20px; font-size: 16px;">No stream active</p>
            <p style="font-size: 13px;">Select camera and click Start Preview</p>
        </div>

        <!-- MJPEG Stream -->
        <img ng-if="msg.stream_url"
             ng-src="{{msg.stream_url}}"
             style="max-width: 100%; max-height: 100%; object-fit: contain;">

        <!-- Overlay info -->
        <div ng-if="msg.stream_url" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 4px; font-size: 11px;">
            <div>{{selectedCameraDisplayName}}</div>
            <div style="margin-top: 2px;">1280×720 @ 15fps</div>
        </div>
    </div>

    <!-- Controls -->
    <div style="background: #2c2c2c; padding: 10px;">

        <!-- Main control row -->
        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">

            <!-- Start/Stop buttons -->
            <button style="background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px;"
                    ng-click="startPreview()"
                    ng-disabled="msg.payload.streaming">
                <i class="fa fa-play"></i>
                <span>Start Preview</span>
            </button>

            <button style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px;"
                    ng-click="stopPreview()"
                    ng-disabled="!msg.payload.streaming">
                <i class="fa fa-stop"></i>
                <span>Stop Preview</span>
            </button>

            <!-- Separator -->
            <div style="width: 1px; height: 25px; background: #555; margin: 0 5px;"></div>

            <!-- Camera selection -->
            <div style="display: flex; align-items: center; gap: 10px;">
                <label style="color: #999; font-size: 13px;">Camera:</label>

                <select id="camera-dropdown"
                        style="background: #333; color: white; border: 1px solid #555; padding: 6px 10px; border-radius: 4px; font-size: 13px; min-width: 180px; cursor: pointer;"
                        ng-model="selectedCamera"
                        ng-change="onCameraChange()">
                    <!-- Options will be added dynamically -->
                    <option value="test">Test Image Generator</option>
                </select>

                <button style="background: #555; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 13px;"
                        ng-click="refreshCameras()"
                        title="Refresh camera list">
                    <i class="fa fa-refresh"></i>
                </button>
            </div>
        </div>

        <!-- Status bar -->
        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #444; color: #666; font-size: 10px; display: flex; justify-content: space-between;">
            <span>Status: {{msg.payload.streaming ? 'Streaming' : 'Ready'}}</span>
            <span>Selected: {{selectedCameraDisplayName}}</span>
            <span>Format: MJPEG | Resolution: 1280×720</span>
        </div>
    </div>
</div>

<script>
(function(scope) {
    // === INITIALIZATION ===
    // Initialize with existing selection if available, otherwise default to 'test'
    if (!scope.selectedCamera) {
        scope.selectedCamera = 'test';
    }
    scope.availableCameras = [];
    scope.cameraDisplayNames = {};

    // Set initial display name
    var initialNames = {
        'test': 'Test Image Generator',
        'usb_0': 'USB Camera 0',
        'usb_1': 'USB Camera 1',
        'usb_2': 'USB Camera 2'
    };
    scope.selectedCameraDisplayName = initialNames[scope.selectedCamera] || scope.selectedCamera;

    // === HELPER FUNCTIONS ===

    // Update display name for selected camera
    function updateDisplayName() {
        if (scope.cameraDisplayNames[scope.selectedCamera]) {
            scope.selectedCameraDisplayName = scope.cameraDisplayNames[scope.selectedCamera];
        } else {
            // Fallback names
            var fallbackNames = {
                'test': 'Test Image Generator',
                'usb_0': 'USB Camera 0',
                'usb_1': 'USB Camera 1',
                'usb_2': 'USB Camera 2'
            };
            scope.selectedCameraDisplayName = fallbackNames[scope.selectedCamera] || scope.selectedCamera;
        }
        console.log('[Live Preview] Display name updated to:', scope.selectedCameraDisplayName);
    }

    // Get display name for selected camera (for Angular binding)
    scope.getCameraDisplayName = function() {
        return scope.selectedCameraDisplayName;
    };

    // === CONTROL FUNCTIONS ===

    // Start preview with selected camera
    scope.startPreview = function() {
        console.log('[Live Preview] Starting with camera:', scope.selectedCamera);
        scope.send({
            payload: {
                command: 'start',
                camera_id: scope.selectedCamera
            }
        });
    };

    // Stop preview
    scope.stopPreview = function() {
        console.log('[Live Preview] Stopping preview');
        scope.send({
            payload: {
                command: 'stop'
            }
        });
    };

    // Handle camera selection change
    scope.onCameraChange = function() {
        console.log('[Live Preview] Camera changed to:', scope.selectedCamera);

        // Update display name
        updateDisplayName();

        // If currently streaming, switch to new camera
        if (scope.msg && scope.msg.payload && scope.msg.payload.streaming) {
            console.log('[Live Preview] Switching active stream to:', scope.selectedCamera);
            scope.send({
                payload: {
                    camera_id: scope.selectedCamera
                }
            });
        }
    };

    // === CAMERA LOADING ===

    // Load cameras from API
    function loadCamerasFromAPI() {
        console.log('[Live Preview] Loading cameras from API...');

        var xhr = new XMLHttpRequest();
        xhr.open('POST', 'http://localhost:8000/api/camera/list', true);
        xhr.setRequestHeader('Content-Type', 'application/json');

        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    try {
                        var cameras = JSON.parse(xhr.responseText);
                        console.log('[Live Preview] Cameras loaded:', cameras);

                        // Store cameras
                        scope.availableCameras = cameras;

                        // Update dropdown
                        updateCameraDropdown(cameras);

                        // Force Angular update
                        scope.$apply();

                    } catch (e) {
                        console.error('[Live Preview] Error parsing cameras:', e);
                        useDefaultCameras();
                    }
                } else {
                    console.error('[Live Preview] Failed to load cameras, status:', xhr.status);
                    useDefaultCameras();
                }
            }
        };

        xhr.onerror = function() {
            console.error('[Live Preview] Network error loading cameras');
            useDefaultCameras();
        };

        // Send request
        xhr.send(JSON.stringify({}));
    }

    // Update dropdown with camera list
    function updateCameraDropdown(cameras) {
        var dropdown = document.getElementById('camera-dropdown');
        if (!dropdown) {
            console.error('[Live Preview] Dropdown not found');
            return;
        }

        // Save current selection - IMPORTANT: use scope.selectedCamera as primary source
        var currentSelection = scope.selectedCamera || dropdown.value || 'test';
        console.log('[Live Preview] Current selection before update:', currentSelection);

        // Clear and rebuild options
        dropdown.innerHTML = '';

        var selectionFound = false;

        if (cameras && cameras.length > 0) {
            cameras.forEach(function(camera) {
                // Store display name
                scope.cameraDisplayNames[camera.id] = camera.name;

                // Create option
                var option = document.createElement('option');
                option.value = camera.id;
                option.text = camera.name + (camera.connected ? ' ✓' : ' ✗');

                // Maintain selection
                if (camera.id === currentSelection) {
                    option.selected = true;
                    selectionFound = true;
                }

                dropdown.appendChild(option);
            });

            console.log('[Live Preview] Added', cameras.length, 'cameras to dropdown');
        } else {
            // Add at least the test camera
            var testOption = document.createElement('option');
            testOption.value = 'test';
            testOption.text = 'Test Image Generator';
            dropdown.appendChild(testOption);
            if (currentSelection === 'test') {
                selectionFound = true;
            }
        }

        // Restore selection
        if (selectionFound) {
            dropdown.value = currentSelection;
            scope.selectedCamera = currentSelection;
            updateDisplayName();
            console.log('[Live Preview] Selection restored to:', currentSelection);
        } else {
            // If current selection not in list, default to first option
            if (dropdown.options.length > 0) {
                dropdown.value = dropdown.options[0].value;
                scope.selectedCamera = dropdown.options[0].value;
                updateDisplayName();
                console.log('[Live Preview] Selection not found, defaulting to:', dropdown.options[0].value);
            }
        }

        // If streaming and selection changed, update the stream
        if (scope.msg && scope.msg.payload && scope.msg.payload.streaming) {
            if (scope.selectedCamera !== currentSelection) {
                console.log('[Live Preview] Camera changed during refresh, switching stream to:', scope.selectedCamera);
                scope.send({
                    payload: {
                        camera_id: scope.selectedCamera
                    }
                });
            }
        }

        // Force Angular update
        setTimeout(function() {
            scope.$apply();
        }, 50);
    }

    // Use default cameras if API fails
    function useDefaultCameras() {
        console.log('[Live Preview] Using default camera list');

        var defaultCameras = [
            {id: 'test', name: 'Test Image Generator', connected: true}
        ];

        scope.availableCameras = defaultCameras;
        updateCameraDropdown(defaultCameras);
    }

    // Refresh camera list
    scope.refreshCameras = function() {
        console.log('[Live Preview] Manual refresh triggered');
        loadCamerasFromAPI();
    };

    // === WATCHERS ===

    // Watch for selectedCamera changes
    scope.$watch('selectedCamera', function(newVal, oldVal) {
        if (newVal && newVal !== oldVal) {
            console.log('[Live Preview] selectedCamera changed from', oldVal, 'to', newVal);
            updateDisplayName();
        }
    });

    // Watch for incoming camera_id changes from flow
    scope.$watch('msg.camera_id', function(newVal) {
        if (newVal && newVal !== scope.selectedCamera) {
            console.log('[Live Preview] Camera updated from message:', newVal);
            scope.selectedCamera = newVal;
            updateDisplayName();

            // Update dropdown to match
            var dropdown = document.getElementById('camera-dropdown');
            if (dropdown) {
                dropdown.value = newVal;
                // Verify the option exists
                if (dropdown.value !== newVal) {
                    console.log('[Live Preview] Camera', newVal, 'not in dropdown, will be added on next refresh');
                }
            }
        }
    });

    // Also watch for payload.camera_id changes
    scope.$watch('msg.payload.camera_id', function(newVal) {
        if (newVal && newVal !== scope.selectedCamera) {
            console.log('[Live Preview] Camera updated from payload:', newVal);
            scope.selectedCamera = newVal;
            updateDisplayName();

            var dropdown = document.getElementById('camera-dropdown');
            if (dropdown) {
                dropdown.value = newVal;
            }
        }
    });

    // Watch for streaming state changes
    scope.$watch('msg.payload.streaming', function(newVal) {
        console.log('[Live Preview] Streaming state:', newVal);
    });

    // === INITIALIZATION ===

    // Set up dropdown event listener
    setTimeout(function() {
        var dropdown = document.getElementById('camera-dropdown');
        if (dropdown) {
            dropdown.addEventListener('change', function(e) {
                console.log('[Live Preview] Dropdown changed via event to:', e.target.value);
                scope.selectedCamera = e.target.value;
                updateDisplayName();
                scope.onCameraChange();
                scope.$apply();
            });
        }
    }, 100);

    // Load cameras on startup
    setTimeout(function() {
        console.log('[Live Preview] Initial camera load');
        loadCamerasFromAPI();
    }, 500);

    // Log initialization
    console.log('[Live Preview] Template loaded and ready');

})(scope);
</script>