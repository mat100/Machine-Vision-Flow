<!-- SIMPLE WORKING VERSION - PROPERLY DONE -->

<div style="background: #1e1e1e; border-radius: 8px; width: 100%; margin: 0; padding: 0; box-sizing: border-box;">

    <!-- Header -->
    <div style="background: #2196F3; color: white; padding: 10px 15px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 16px; font-weight: 500;">
                <i class="fa fa-video-camera"></i> Live Preview
            </span>
            <span style="font-size: 14px;">
                <span ng-if="msg.payload.streaming" style="color: #4CAF50;">● STREAMING</span>
                <span ng-if="!msg.payload.streaming" style="color: #f44336;">● STOPPED</span>
            </span>
        </div>
    </div>

    <!-- Image Display -->
    <div style="position: relative; width: 100%; height: 380px; background: black; display: flex; align-items: center; justify-content: center; overflow: hidden;">

        <!-- No stream message -->
        <div ng-if="!msg.stream_url" style="text-align: center; color: #888;">
            <i class="fa fa-video-camera fa-3x" style="opacity: 0.3;"></i>
            <p style="margin-top: 20px; font-size: 16px;">No stream active</p>
            <p style="font-size: 13px;">Select camera and click Start Preview</p>
        </div>

        <!-- MJPEG Stream -->
        <img ng-if="msg.stream_url"
             ng-src="{{msg.stream_url}}"
             style="max-width: 100%; max-height: 100%; object-fit: contain;">

        <!-- Overlay info -->
        <div ng-if="msg.stream_url" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 4px; font-size: 11px;">
            <div>{{selectedCameraName}}</div>
            <div style="margin-top: 2px;">1280×720 @ 15fps</div>
        </div>
    </div>

    <!-- Controls -->
    <div style="background: #2c2c2c; padding: 10px;">

        <!-- Main control row -->
        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">

            <!-- Start/Stop buttons -->
            <button style="background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px;"
                    ng-click="startPreview()"
                    ng-disabled="msg.payload.streaming">
                <i class="fa fa-play"></i>
                <span>Start Preview</span>
            </button>

            <button style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px;"
                    ng-click="stopPreview()"
                    ng-disabled="!msg.payload.streaming">
                <i class="fa fa-stop"></i>
                <span>Stop Preview</span>
            </button>

            <!-- Separator -->
            <div style="width: 1px; height: 25px; background: #555; margin: 0 5px;"></div>

            <!-- Camera selection -->
            <div style="display: flex; align-items: center; gap: 10px;">
                <label style="color: #999; font-size: 13px;">Camera:</label>

                <select id="camera-dropdown"
                        style="background: #333; color: white; border: 1px solid #555; padding: 6px 10px; border-radius: 4px; font-size: 13px; min-width: 180px; cursor: pointer;"
                        ng-model="selectedCamera"
                        ng-change="onCameraChange()">
                    <!-- Static options that always work -->
                    <option value="test">Test Image Generator</option>
                    <option value="usb_0">USB Camera 0</option>
                    <option value="usb_1">USB Camera 1</option>
                    <option value="usb_2">USB Camera 2</option>
                </select>
            </div>
        </div>

        <!-- Status bar -->
        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #444; color: #666; font-size: 10px; display: flex; justify-content: space-between;">
            <span>Status: {{msg.payload.streaming ? 'Streaming' : 'Ready'}}</span>
            <span>Selected: {{selectedCameraName}}</span>
            <span>Format: MJPEG | Resolution: 1280×720</span>
        </div>
    </div>
</div>

<script>
(function(scope) {
    // === INITIALIZATION ===

    // Default camera selection
    if (!scope.selectedCamera) {
        scope.selectedCamera = 'test';
    }

    // Camera display names
    var cameraNames = {
        'test': 'Test Image Generator',
        'usb_0': 'USB Camera 0',
        'usb_1': 'USB Camera 1',
        'usb_2': 'USB Camera 2'
    };

    // Set initial display name
    scope.selectedCameraName = cameraNames[scope.selectedCamera] || scope.selectedCamera;

    // === CONTROL FUNCTIONS ===

    // Start preview with selected camera
    scope.startPreview = function() {
        console.log('[Live Preview] Starting with camera:', scope.selectedCamera);
        scope.send({
            payload: {
                command: 'start',
                camera_id: scope.selectedCamera
            }
        });
    };

    // Stop preview
    scope.stopPreview = function() {
        console.log('[Live Preview] Stopping preview');
        scope.send({
            payload: {
                command: 'stop'
            }
        });
    };

    // Handle camera selection change
    scope.onCameraChange = function() {
        console.log('[Live Preview] Camera changed to:', scope.selectedCamera);

        // Update display name
        scope.selectedCameraName = cameraNames[scope.selectedCamera] || scope.selectedCamera;

        // If currently streaming, switch to new camera
        if (scope.msg && scope.msg.payload && scope.msg.payload.streaming) {
            console.log('[Live Preview] Switching active stream to:', scope.selectedCamera);
            scope.send({
                payload: {
                    camera_id: scope.selectedCamera
                }
            });
        }
    };

    // === WATCHERS ===

    // Watch for incoming camera_id changes from flow
    scope.$watch('msg.camera_id', function(newVal) {
        if (newVal && newVal !== scope.selectedCamera) {
            console.log('[Live Preview] Camera updated from message:', newVal);
            scope.selectedCamera = newVal;
            scope.selectedCameraName = cameraNames[newVal] || newVal;
        }
    });

    // Watch for streaming state changes
    scope.$watch('msg.payload.streaming', function(newVal) {
        console.log('[Live Preview] Streaming state:', newVal);
    });

    // Log initialization
    console.log('[Live Preview] Template loaded and ready, selected:', scope.selectedCamera);

})(scope);
</script>