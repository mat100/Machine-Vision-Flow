<!-- NO SCROLL VERSION -->

<div style="background: #1e1e1e; border-radius: 8px; width: 100%; margin: 0; padding: 0; box-sizing: border-box;">

    <!-- Header -->
    <div style="background: #2196F3; color: white; padding: 10px 15px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 16px; font-weight: 500;">
                <i class="fa fa-video-camera"></i> Live Preview
            </span>
            <span style="font-size: 14px;">
                <span ng-if="msg.payload.streaming" style="color: #4CAF50;">● ON</span>
                <span ng-if="!msg.payload.streaming" style="color: #f44336;">● OFF</span>
            </span>
        </div>
    </div>

    <!-- Image Display -->
    <div style="position: relative; width: 100%; height: 400px; background: black; display: flex; align-items: center; justify-content: center; overflow: hidden;">
        <!-- No stream message -->
        <div ng-if="!msg.stream_url" style="text-align: center; color: #888;">
            <i class="fa fa-video-camera fa-3x" style="opacity: 0.3;"></i>
            <p>No stream active</p>
            <p style="font-size: 12px;">Select camera and click Start</p>
        </div>

        <!-- MJPEG Stream -->
        <img ng-if="msg.stream_url"
             ng-src="{{msg.stream_url}}"
             style="max-width: 100%; max-height: 100%; object-fit: contain;">

        <!-- Overlay info -->
        <div ng-if="msg.stream_url" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;">
            {{selectedCameraName || msg.camera_id}}
        </div>
    </div>

    <!-- Controls -->
    <div style="background: #2c2c2c; padding: 10px;">

        <!-- Buttons and Camera Selection in one row -->
        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">

            <!-- Control buttons -->
            <button style="background: #4CAF50; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 13px;"
                    ng-click="startPreview()"
                    ng-disabled="msg.payload.streaming">
                <i class="fa fa-play"></i> Start
            </button>

            <button style="background: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 13px;"
                    ng-click="stopPreview()"
                    ng-disabled="!msg.payload.streaming">
                <i class="fa fa-stop"></i> Stop
            </button>

            <!-- Separator -->
            <div style="width: 1px; height: 20px; background: #555; margin: 0 5px;"></div>

            <!-- Camera selection -->
            <span style="color: #888; font-size: 13px;">Camera:</span>

            <div id="camera-list-container" style="display: inline-flex; gap: 12px;">
                <!-- Cameras will be inserted here -->
                <span style="color: #666; font-size: 12px;">Loading...</span>
            </div>

            <!-- Refresh button -->
            <button style="background: #555; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: auto;"
                    ng-click="refreshCameras()">
                <i class="fa fa-refresh"></i>
            </button>
        </div>

        <!-- Mini status line -->
        <div style="color: #555; font-size: 10px; margin-top: 8px;">
            <span id="selected-camera-display">test</span> | 1280×720 @ 15fps | MJPEG
        </div>
    </div>
</div>

<script>
(function(scope) {
    var cameras = [];
    var selectedCamera = 'test';
    var selectedCameraName = 'Test Image';

    // Start preview
    scope.startPreview = function() {
        console.log('Starting preview with camera:', selectedCamera);
        scope.send({
            payload: {
                command: 'start',
                camera_id: selectedCamera
            }
        });
    };

    // Stop preview
    scope.stopPreview = function() {
        console.log('Stopping preview');
        scope.send({
            payload: {
                command: 'stop'
            }
        });
    };

    // Function to select camera
    function selectCamera(cameraId, cameraName) {
        console.log('Selecting camera:', cameraId);
        selectedCamera = cameraId;
        selectedCameraName = cameraName;
        scope.selectedCameraName = cameraName;

        // Update display
        var display = document.getElementById('selected-camera-display');
        if (display) {
            display.textContent = cameraName;
        }

        // Update radio buttons
        var radios = document.querySelectorAll('input[name="camera-select"]');
        radios.forEach(function(radio) {
            radio.checked = (radio.value === cameraId);
        });

        // If streaming, switch camera
        if (scope.msg && scope.msg.payload && scope.msg.payload.streaming) {
            console.log('Switching to camera:', cameraId);
            scope.send({
                payload: {
                    camera_id: cameraId
                }
            });
        }
    }

    // Render camera list - COMPACT HORIZONTAL
    function renderCameras(cameraList) {
        console.log('Rendering cameras:', cameraList);
        var container = document.getElementById('camera-list-container');
        if (!container) {
            console.error('Camera list container not found!');
            return;
        }

        // Clear container
        container.innerHTML = '';

        // Create COMPACT radio buttons
        cameraList.forEach(function(camera, index) {
            var label = document.createElement('label');
            label.style.cssText = 'color: #ddd; display: inline-flex; align-items: center; font-size: 12px; cursor: pointer;';

            var radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = 'camera-select';
            radio.value = camera.id;
            radio.style.cssText = 'margin-right: 4px; transform: scale(0.9);';

            if (index === 0 || camera.id === selectedCamera) {
                radio.checked = true;
                selectCamera(camera.id, camera.name);
            }

            radio.onclick = function() {
                selectCamera(camera.id, camera.name);
            };

            var text = camera.name;
            if (camera.connected) {
                text = camera.name + ' ✓';
            }

            label.appendChild(radio);
            label.appendChild(document.createTextNode(text));
            container.appendChild(label);
        });

        console.log('Cameras rendered successfully');
    }

    // Load cameras from API
    function loadCameras() {
        console.log('Loading cameras from API...');

        var xhr = new XMLHttpRequest();
        xhr.open('POST', 'http://localhost:8000/api/camera/list', true);
        xhr.setRequestHeader('Content-Type', 'application/json');

        xhr.onload = function() {
            if (xhr.status === 200) {
                try {
                    cameras = JSON.parse(xhr.responseText);
                    console.log('Cameras loaded from API:', cameras);

                    if (!cameras || cameras.length === 0) {
                        cameras = [
                            {id: 'test', name: 'Test', type: 'test', connected: true},
                            {id: 'usb_0', name: 'USB 0', type: 'usb', connected: false},
                            {id: 'usb_1', name: 'USB 1', type: 'usb', connected: true}
                        ];
                    }
                } catch(e) {
                    console.error('Failed to parse camera list:', e);
                    cameras = [
                        {id: 'test', name: 'Test', type: 'test', connected: true},
                        {id: 'usb_0', name: 'USB 0', type: 'usb', connected: false},
                        {id: 'usb_1', name: 'USB 1', type: 'usb', connected: true}
                    ];
                }
            } else {
                cameras = [
                    {id: 'test', name: 'Test', type: 'test', connected: true},
                    {id: 'usb_0', name: 'USB 0', type: 'usb', connected: false},
                    {id: 'usb_1', name: 'USB 1', type: 'usb', connected: true}
                ];
            }

            renderCameras(cameras);
        };

        xhr.onerror = function() {
            console.error('Network error loading cameras');
            cameras = [
                {id: 'test', name: 'Test', type: 'test', connected: true},
                {id: 'usb_0', name: 'USB 0', type: 'usb', connected: false},
                {id: 'usb_1', name: 'USB 1', type: 'usb', connected: true}
            ];
            renderCameras(cameras);
        };

        xhr.send();
    }

    // Refresh cameras
    scope.refreshCameras = function() {
        console.log('Refreshing camera list...');
        loadCameras();
    };

    // Initialize - load cameras after DOM is ready
    setTimeout(function() {
        loadCameras();
    }, 100);

    // Watch for camera_id in messages
    scope.$watch('msg.camera_id', function(newVal) {
        if (newVal) {
            var camera = cameras.find(function(c) { return c.id === newVal; });
            if (camera) {
                selectCamera(camera.id, camera.name);
            }
        }
    });
})(scope);
</script>